/*
 * generated by Xtext 2.21.0
 */
package org.xtext.example.mydsl.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import org.xtext.example.mydsl.stateMachine.StateMachine
import org.xtext.example.mydsl.stateMachine.Instruction
import org.eclipse.xtext.naming.IQualifiedNameProvider
import javax.inject.Inject

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class StateMachineGenerator extends AbstractGenerator {
	
	
	override void doGenerate(Resource res, IFileSystemAccess2 fsa, IGeneratorContext context) {
		for (e : res.allContents.toIterable.filter(StateMachine)){
			fsa.generateFile("StateObject.py", e.compileStateObject)
			fsa.generateFile("States.py", e.compileStateMachineStates)
			fsa.generateFile("MyDevice", e.compileStateDevice)
			}
	}
	
	def CharSequence compileStateDevice(StateMachine machine)
	'''
	from States import ClosedState
	class MyDevice(object):
		def __init__(self):
			self.stare = closedState()
		def on_event(self, event):
			self.state = self.state.on_event(event)
	'''
	
	def CharSequence compileStateMachineStates(StateMachine model)
	'''
		from state import State
		«FOR e : model.event»
		«generateStates(model)»(State):
			
		«ENDFOR»
		
		class doorClosed
		
		
		class drawOpened
	'''
	
	def generateStates(StateMachine model) {
		'''
			«FOR e : model.event»
			class «e.name»(State):
				def on_event(self, event):
					if event == '«FOR i:model.state»«i.name»«ENDFOR»'
			«ENDFOR»
		'''
	}
	
	def CharSequence compileStateObject(StateMachine model)
	'''
		class State (object):
		    """
		    We define a state object which provides some utility functions for the
		    individual states within the state machine.
		    """
		
		    def __init__(self):
		        print 'Processing current state:', str(self)
		
		    def on_event(self, event):
		        """
		        Handle events that are delegated to this State.
		        """
		        pass
		
		    def __repr__(self):
		        """
		        Leverages the __str__ method to describe the State.
		        """
		        return self.__str__()
		
		    def __str__(self):
		        """
		        Returns the name of the State.
		        """
		        return self.__class__.__name__
	'''
	
	
	


	
	def getName(Resource resource){
		var name = resource.URI.lastSegment
		return name.substring(0, name.indexOf('.')).toFirstUpper
	}
	
	
}