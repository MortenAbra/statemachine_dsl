/*
 * generated by Xtext 2.21.0
 */
package org.xtext.example.mydsl.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import org.xtext.example.mydsl.stateMachine.StateMachine
import org.xtext.example.mydsl.stateMachine.Instruction
import org.eclipse.xtext.naming.IQualifiedNameProvider
import javax.inject.Inject

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class StateMachineGenerator extends AbstractGenerator {
	
	
	override void doGenerate(Resource res, IFileSystemAccess2 fsa, IGeneratorContext context) {
		for (e : res.allContents.toIterable.filter(StateMachine)){
			fsa.generateFile(e.eResource.name+".py", e.compileStateObject)
			}
	}
	
	def CharSequence compileStateDevice(StateMachine model)
	'''
	«FOR e : model.state»
	from states import «e.moves.state.name»
	class MyDevice«for (i: 0 .. model.state.length){
		i.toString()
	}» (object):
		def __init__(self):
			self.stare = «e.moves.state.name»
		def on_event(self, event):
			self.state = self.state.on_event(event)
			
	«ENDFOR»
	
	'''
	
	def CharSequence compileStateMachineStates(StateMachine model)
	'''
		from state import State
		«FOR e : model.state»
		class «e.name»(State):
			def on_event(self, event):
				if event == '«e.moves.event.name»':
					return «e.moves.state.name»()
		«ENDFOR»
		
	'''
	
	def generateStates(StateMachine model) {
		'''
			«FOR e : model.event»
			class «e.name»(State):
				def on_event(self, event):
					if event == '«»'
			«ENDFOR»
		'''
	}
	
	def CharSequence compileStateObject(StateMachine model)
	'''
		class State (object):
		    """
		    We define a state object which provides some utility functions for the
		    individual states within the state machine.
		    """
		
		    def __init__(self):
		        print 'Processing current state:', str(self)
		
		    def on_event(self, event):
		        """
		        Handle events that are delegated to this State.
		        """
		        pass
		
		    def __repr__(self):
		        """
		        Leverages the __str__ method to describe the State.
		        """
		        return self.__str__()
		
		    def __str__(self):
		        """
		        Returns the name of the State.
		        """
		        return self.__class__.__name__
	'''
	
	
	


	
	def getName(Resource resource){
		var name = resource.URI.lastSegment
		return name.substring(0, name.indexOf('.')).toFirstUpper
	}
	
	
}